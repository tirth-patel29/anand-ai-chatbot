// ========== LANGUAGE TRANSLATIONS ==========
const translations = {
    gujarati: {
        langText: "English",
        heroTitle: "ркдркорк╛рк░рлА ркмрк┐ркЬрк▓рлА рк╡рк┐рк╢рлЗ ркХркВркИ рккркг рккрлВркЫрлЛ тАУ ркдрк░ркд ркЬ",
        heroSubtitle: "ркмрк┐рк▓, рккрк╛рк╡рк░ ркХркЯ, ркирк╡рк╛ ркХркирлЗркХрлНрк╢рки ркЕркирлЗ рк╡ркзрлБ рк╡рк┐рк╢рлЗ ркдрк░ркд ркЬрк╡рк╛ркм ркорлЗрк│рк╡рлЛ.",
        chatBtnText: "ркЪрлЗркЯ рк╢рк░рлВ ркХрк░рлЛ",
        chatHeading: "Anand Dhokai AI рк╕рк╛ркерлЗ ркЪрлЗркЯ ркХрк░рлЛ",
        billBtn: "ЁЯТ░ ркмрк┐рк▓ рк╕ркорк╕рлНркпрк╛",
        powerBtn: "тЪб рккрк╛рк╡рк░ ркХркЯ",
        connBtn: "ЁЯФМ ркирк╡рлБркВ ркХркирлЗркХрлНрк╢рки",
        complaintBtn: "ЁЯУЛ рклрк░рк┐ркпрк╛ркж",
        disclaimer: "ркЖ ркПркЖркИ ркорк╛ркдрлНрк░ ркорк╛рк░рлНркЧркжрк░рлНрк╢рки ркЖрккрлЗ ркЫрлЗ. ркЕркзрк┐ркХрлГркд рккркЧрк▓рк╛ркВ ркорк╛ркЯрлЗ, ркЧрлБркЬрк░рк╛ркд ркЗрк▓рлЗркХрлНркЯрлНрк░рк┐ркХ ркмрлЛрк░рлНркбркирлЛ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ.",
        greeting: "ркиркорк╕рлНркдрлЗ! ркорлБркВ Anand Dhokai ркЫрлБркВ. ркдркорк╛рк░рлА ркмрк┐ркЬрк▓рлА рк╕ркорк╕рлНркпрк╛ркирлБркВ рк╕ркорк╛ркзрк╛рки ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркЕрк╣рлАркВ ркЫрлБркВ. ЁЯОп",
        typing: "Anand Dhokai ркЯрк╛ркЗркк ркХрк░рлА рк░рк╣рлНркпрлБркВ ркЫрлЗ...",
        clearBtn: "ркЪрлЗркЯ ркЗркдрк┐рк╣рк╛рк╕ рк╕рк╛ркл ркХрк░рлЛ",
        featuresTitle: "Anand Dhokai AI рк╢рк╛ ркорк╛ркЯрлЗ рккрк╕ркВркж ркХрк░рлЛ?",
        feat1: "24/7 рк╕рк╣рк╛ркп",
        featDesc1: "ркЬрлНркпрк╛рк░рлЗ рккркг ркдркоркирлЗ ркдркорк╛рк░рлА ркмрк┐ркЬрк▓рлА ркХрлНрк╡рлЗрк░рлАркорк╛ркВ рк╕рк╣рк╛ркп ркХрк░рк╡рк╛ркирлА ркЬрк░рлВрк░ рк╣рлЛркп ркдрлНркпрк╛рк░рлЗ рк╣ркВркорлЗрк╢рк╛ ркЙрккрк▓ркмрлНркз.",
        feat2: "ркдрк░ркд ркЬрк╡рк╛ркм",
        featDesc2: "ркЧрлНрк░рк╛рк╣ркХ рк╕рлЗрк╡рк╛ркирлА рк░рк╛рк╣ ркЬрлЛркпрк╛ рк╡рк┐ркирк╛ ркЭркбрккрлА ркЬрк╡рк╛ркм ркорлЗрк│рк╡рлЛ.",
        feat3: "ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ рк╕ркорк░рлНркерки",
        featDesc3: "ркдркорк╛рк░рлА рккрк╕ркВркжркирлА ркнрк╛рк╖рк╛ркорк╛ркВ рк╕ркВркЪрк╛рк░ ркХрк░рлЛ - ркЧрлБркЬрк░рк╛ркдрлА ркЕркерк╡рк╛ ркЕркВркЧрлНрк░рлЗркЬрлА.",
        feat4: "рк╕рк░рк│ ркЕркирлЗ рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛-ркорлИркдрлНрк░рлА",
        featDesc4: "ркжрк░рлЗркХ ркорк╛ркЯрлЗ ркбрк┐ркЭрк╛ркИрки ркХрк░рк╛ркпрлЗрк▓ рк╕рк░рк│ ркЗркирлНркЯрк░рклрлЗрк╕, рк╡рк░рк┐рк╖рлНрка ркирк╛ркЧрк░рк┐ркХрлЛ рк╕рк╣рк┐ркд.",
        howTitle: "ркдрлЗ ркХрлЗрк╡рлА рк░рлАркдрлЗ ркХрк╛рко ркХрк░рлЗ ркЫрлЗ",
        step1: "ркдркорк╛рк░рк╛ рккрлНрк░рк╢рлНркиркирлЛ рккрлВркЫрлЛ",
        stepDesc1: "ркдркорк╛рк░рлА ркмрк┐ркЬрк▓рлА-рк╕ркВркмркВркзрк┐ркд ркХрлНрк╡рлЗрк░рлА рк╕рк░рк│ ркнрк╛рк╖рк╛ркорк╛ркВ ркЯрк╛ркЗркк ркХрк░рлЛ.",
        step2: "ркдрк░ркд ркЬрк╡рк╛ркм ркорлЗрк│рк╡рлЛ",
        stepDesc2: "ркПркЖркИ рккрлНрк░ркХрлНрк░рк┐ркпрк╛ ркХрк░рлЗ ркЫрлЗ ркЕркирлЗ ркдрк░ркд ркЬ рк╕ркВркмркВркзрк┐ркд ркорк╛рк░рлНркЧркжрк░рлНрк╢рки ркЖрккрлЗ ркЫрлЗ.",
        step3: "рккркЧрк▓рлБркВ рк▓рлЛ",
        stepDesc3: "ркорк╛рк░рлНркЧркжрк░рлНрк╢ркиркирлЗ ркЕркирлБрк╕рк░рлЛ ркЕркерк╡рк╛ ркЖрк╡рк╢рлНркпркХ рк╣рлЛркп ркдрлЛ GEB рк╕рк╛ркерлЗ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ.",
        disclaimerText: "ркЖ ркПркЖркИ ркорк╛ркдрлНрк░ ркорк╛рк░рлНркЧркжрк░рлНрк╢рки ркЕркирлЗ ркорк╛рк╣рк┐ркдрлА ркЖрккрлЗ ркЫрлЗ. ркЕркзрк┐ркХрлГркд рккркЧрк▓рк╛ркВ, ркЦрк╛ркдрк╛ркирлА ркмркжрк▓рлА, ркмрк┐рк▓ рк╡рк┐рк╡рк╛ркж ркЕркерк╡рк╛ ркХркЯрлЛркХркЯрлАркирлА рк╕рлЗрк╡рк╛ркУ ркорк╛ркЯрлЗ, рк╕рлАркзрлБркВ ркЧрлБркЬрк░рк╛ркд ркЗрк▓рлЗркХрлНркЯрлНрк░рк┐ркХ ркмрлЛрк░рлНркбркирлЛ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ.",
        contactInfo: "GEB ркЧрлНрк░рк╛рк╣ркХ ркХрлЗркпрк░: 1912 (ркЯрлЛрк▓-рклрлНрк░рлА)",
        footerAbout: "Anand Dhokai AI - ркдркорк╛рк░рлБркВ ркЧрлБркЬрк░рк╛ркд ркЗрк▓рлЗркХрлНркЯрлНрк░рк┐рк╕рк┐ркЯрлА рк╕рлЗрк╡рк╛ркУ ркорк╛ркЯрлЗ рк╕рлНркорк╛рк░рлНркЯ рк╕рк╣рк╛ркпркХ.",
        privacy: "ркЧрлЛрккркирлАркпркдрк╛ ркирлАркдрк┐",
        terms: "ркЙрккркпрлЛркЧркирлА рк╢рк░ркдрлЛ",
        contact: "рк╕ркВрккрк░рлНркХ",
        gebInfo: "GEB рк╕ркВрккрк░рлНркХ",
        copyright: "┬й 2025 Anand Dhokai AI. ркмркзрк╛ ркЕркзрк┐ркХрк╛рк░рлЛ ркЖрк░ркХрлНрк╖рк┐ркд ркЫрлЗ.",
        disclaimerSmall: "ркЖ ркПркЖркИ ркорк╛ркдрлНрк░ ркорк╛рк░рлНркЧркжрк░рлНрк╢рки ркЖрккрлЗ ркЫрлЗ. ркЕркзрк┐ркХрлГркд рккркЧрк▓рк╛ркВ ркорк╛ркЯрлЗ, ркЧрлБркЬрк░рк╛ркд ркЗрк▓рлЗркХрлНркЯрлНрк░рк┐ркХ ркмрлЛрк░рлНркбркирлЛ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ.",
        // Gujarati responses for quick buttons
        billResponse: "ркмрк┐рк▓ рк╕ркорк╕рлНркпрк╛ ркорк╛ркЯрлЗ:\n\n1. ркдркорк╛рк░рлЛ GEB ркПркХрк╛ркЙркирлНркЯ ркиркВркмрк░ ркдрккрк╛рк╕рлЛ\n2. ркУркирк▓рк╛ркИрки рккрлЛрк░рлНркЯрк▓ рккрк░ рк▓рлЙркЧрк┐рки ркХрк░рлЛ\n3. ркмрлЛрк▓ркдрк╛ ркмрк┐рк▓ ркдрккрк╛рк╕рлЛ\n4. ркбрк╛ркмркЯ рк╣рлЛркп ркдрлЛ GEB ркХрк╕рлНркЯркорк░ ркХрлЗрк░ 1912 рккрк░ ркХрлЙрк▓ ркХрк░рлЛ\n\nркХрлЛркИ ркЕркирлНркп рккрлНрк░рк╢рлНрки?",
        powerCutResponse: "рккрк╛рк╡рк░ ркХркЯ ркорк╛ркЯрлЗ:\n\n1. ркдркорк╛рк░рлБркВ рк╡рк┐рк╕рлНркдрк╛рк░ ркдрккрк╛рк╕рлЛ - ркдркорк╛ркВ рккрк╛рк╡рк░ ркХркЯ рк╣рлЛркИ рк╢ркХрлЗ ркЫрлЗ\n2. GEB рк╡рлЗркмрк╕рк╛ркИркЯ рккрк░ рк╢рлЗркбрлНркпрлБрк▓ ркЬрлЛрк╡рлЛ\n3. ркмрк┐рк▓ ркмрк╛ркХрлА ркЫрлЗ ркдрлЛ ркдрлЗ ркЪрлВркХрк╡рлЛ\n4. рк╡ркзрлБ ркорк╛рк╣рк┐ркдрлА ркорк╛ркЯрлЗ 1912 рккрк░ ркХрлЙрк▓ ркХрк░рлЛ",
        connectionResponse: "ркирк╡рк╛ ркХркирлЗркХрлНрк╢рки ркорк╛ркЯрлЗ:\n\n1. GEB ркХрк░рлНркпрк╛рк▓ркпркорк╛ркВ рк╡рк┐ркЬрк┐ркЯ ркХрк░рлЛ ркЕркерк╡рк╛ ркУркирк▓рк╛ркИрки ркЖрк╡рлЗркжрки ркХрк░рлЛ\n2. ркЬрк░рлВрк░рлА ркжрк╕рлНркдрк╛рк╡рлЗркЬ ркдрлИркпрк╛рк░ ркХрк░рлЛ (ID, рк╕рк░ркирк╛ркорлБркВ, ркорк┐рк▓ркХркд рккрлБрк░рк╛рк╡рлЛ)\n3. рклрлА ркЪрлВркХрк╡рлЛ\n4. рк╕рк░рлНрк╡рлЗркХрлНрк╖ркг ркЕрккрлЛркИркирлНркЯркорлЗркирлНркЯ ркмрлБркХ ркХрк░рлЛ\n5. ркорлАркЯрк░ ркЗркирлНрк╕рлНркЯрлЛрк▓рлЗрк╢рки ркЕркирлЗ рк╕ркХрлНрк░рк┐ркпркХрк░ркг",
        complaintResponse: "рклрк░рк┐ркпрк╛ркж ркжрк░рлНркЬ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ:\n\n1. GEB рк╡рлЗркмрк╕рк╛ркИркЯ рккрк░ рклрк░рк┐ркпрк╛ркж рккрлЛрк░рлНркЯрк▓ ркЬрк╛ркУ\n2. рклрк░рк┐ркпрк╛ркжркирлА рк╡рк┐ркЧркд ркжрк░рлНрк╢рк╛рк╡рлЛ\n3. ркЖрк╡рк╢рлНркпркХ ркжрк╕рлНркдрк╛рк╡рлЗркЬ ркЕрккрк▓рлЛркб ркХрк░рлЛ\n4. ркЯрлНрк░рлЗркХрк┐ркВркЧ ркиркВркмрк░ рк╕рк╛ркЪрк╡рлЛ\n5. GEB ркдркорк╛рк░рк╛ркирлЗ ркХрлЙрк▓ ркХрк░рк╢рлЗ",
    },
    english: {
        langText: "ркЧрлБркЬрк░рк╛ркдрлА",
        heroTitle: "Ask Anything About Your Electricity тАУ Instantly",
        heroSubtitle: "Get instant answers about bills, power cuts, new connections, and more.",
        chatBtnText: "Start Chat",
        chatHeading: "Chat with Anand Dhokai AI",
        billBtn: "ЁЯТ░ Bill Issue",
        powerBtn: "тЪб Power Cut",
        connBtn: "ЁЯФМ New Connection",
        complaintBtn: "ЁЯУЛ Complaint",
        disclaimer: "This AI provides guidance only. For official actions, contact Gujarat Electric Board.",
        greeting: "Hello! I'm Anand Dhokai, your smart assistant for electricity queries. ЁЯОп",
        typing: "Anand Dhokai is typing...",
        clearBtn: "Clear Chat History",
        featuresTitle: "Why Choose Anand Dhokai AI?",
        feat1: "24/7 Assistance",
        featDesc1: "Always available whenever you need help with your electricity queries.",
        feat2: "Instant Replies",
        featDesc2: "Get quick answers without waiting for customer service.",
        feat3: "Gujarati Language Support",
        featDesc3: "Communicate in your preferred language - Gujarati or English.",
        feat4: "Easy & User Friendly",
        featDesc4: "Simple interface designed for everyone, including senior citizens.",
        howTitle: "How It Works",
        step1: "Ask Your Question",
        stepDesc1: "Type your electricity-related query in simple language.",
        step2: "Get Instant Answer",
        stepDesc2: "AI processes and provides relevant guidance instantly.",
        step3: "Take Action",
        stepDesc3: "Follow the guidance or contact GEB for official help if needed.",
        disclaimerText: "This AI provides guidance and information only. For official actions, account changes, bill disputes, or emergency services, please contact Gujarat Electric Board (GEB) directly.",
        contactInfo: "GEB Customer Care: 1912 (Toll-Free)",
        footerAbout: "Anand Dhokai AI - Your smart assistant for Gujarat Electricity Services.",
        privacy: "Privacy Policy",
        terms: "Terms of Use",
        contact: "Contact",
        gebInfo: "GEB Contact",
        copyright: "┬й 2025 Anand Dhokai AI. All rights reserved.",
        disclaimerSmall: "This AI provides guidance only. For official actions, contact Gujarat Electric Board.",
        // English responses for quick buttons
        billResponse: "For Bill Issues:\n\n1. Check your GEB account number\n2. Login to online portal\n3. View your bill details\n4. If doubt persists, call GEB Customer Care at 1912\n\nNeed more help?",
        powerCutResponse: "For Power Cuts:\n\n1. Check if your area has scheduled power cuts\n2. View schedule on GEB website\n3. Ensure your bill is paid up-to-date\n4. Call 1912 for more information",
        connectionResponse: "For New Connection:\n\n1. Visit GEB office or apply online\n2. Prepare required documents (ID, address proof, property proof)\n3. Pay the application fee\n4. Book survey appointment\n5. Meter installation and activation",
        complaintResponse: "To Register a Complaint:\n\n1. Go to GEB's complaint portal on their website\n2. Fill in complaint details\n3. Upload supporting documents\n4. Save your tracking number\n5. GEB will call you with updates",
    }
};

// ========== STATE MANAGEMENT ==========
let currentLanguage = 'gujarati';
let apiKey = '';
let chatHistory = [];

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
    initializeChat();
    loadAPIKey();
    setLanguage('gujarati');
    document.documentElement.lang = 'gu';
});

function initializeChat() {
    const chatHistory = document.getElementById('chatHistory');
    chatHistory.innerHTML = `
        <div class="message bot-message">
            <p>${translations.gujarati.greeting}</p>
        </div>
    `;
}

// ========== LANGUAGE SWITCHING ==========
function toggleLanguage() {
    currentLanguage = currentLanguage === 'gujarati' ? 'english' : 'gujarati';
    setLanguage(currentLanguage);
    document.documentElement.lang = currentLanguage === 'gujarati' ? 'gu' : 'en';
}

function setLanguage(lang) {
    currentLanguage = lang;
    const t = translations[lang];

    // Update all text elements
    document.getElementById('langText').textContent = t.langText;
    document.getElementById('heroTitle').textContent = t.heroTitle;
    document.getElementById('heroSubtitle').textContent = t.heroSubtitle;
    document.getElementById('chatBtnText').textContent = t.chatBtnText;
    document.getElementById('chatHeading').textContent = t.chatHeading;
    document.getElementById('billBtn').textContent = t.billBtn;
    document.getElementById('powerBtn').textContent = t.powerBtn;
    document.getElementById('connBtn').textContent = t.connBtn;
    document.getElementById('complaintBtn').textContent = t.complaintBtn;
    document.getElementById('disclaimerSmall').textContent = t.disclaimerSmall;
    document.getElementById('clearBtn').textContent = t.clearBtn;
    document.getElementById('featuresTitle').textContent = t.featuresTitle;
    document.getElementById('feat1').textContent = t.feat1;
    document.getElementById('featDesc1').textContent = t.featDesc1;
    document.getElementById('feat2').textContent = t.feat2;
    document.getElementById('featDesc2').textContent = t.featDesc2;
    document.getElementById('feat3').textContent = t.feat3;
    document.getElementById('featDesc3').textContent = t.featDesc3;
    document.getElementById('feat4').textContent = t.feat4;
    document.getElementById('featDesc4').textContent = t.featDesc4;
    document.getElementById('howTitle').textContent = t.howTitle;
    document.getElementById('step1').textContent = t.step1;
    document.getElementById('stepDesc1').textContent = t.stepDesc1;
    document.getElementById('step2').textContent = t.step2;
    document.getElementById('stepDesc2').textContent = t.stepDesc2;
    document.getElementById('step3').textContent = t.step3;
    document.getElementById('stepDesc3').textContent = t.stepDesc3;
    document.getElementById('disclaimerText').textContent = t.disclaimerText;
    document.getElementById('contactInfo').textContent = t.contactInfo;
    document.getElementById('footerAbout').textContent = t.footerAbout;
    document.getElementById('privacyLink').textContent = t.privacy;
    document.getElementById('termsLink').textContent = t.terms;
    document.getElementById('contactLink').textContent = t.contact;
    document.getElementById('gebInfo').textContent = t.gebInfo;
    document.getElementById('copyright').textContent = t.copyright;
    document.getElementById('typingText').textContent = t.typing;

    // Reset greeting
    const chatHistoryDiv = document.getElementById('chatHistory');
    if (chatHistoryDiv.children.length === 0) {
        addBotMessage(t.greeting);
    }
}

// ========== API KEY MANAGEMENT ==========
function openAPIModal() {
    document.getElementById('apiModal').style.display = 'block';
}

function closeAPIModal() {
    document.getElementById('apiModal').style.display = 'none';
}

function saveAPIKey() {
    const apiKeyInput = document.getElementById('apiKeyInput');
    apiKey = apiKeyInput.value.trim();
    
    if (apiKey) {
        localStorage.setItem('openaiAPIKey', apiKey);
        closeAPIModal();
        alert('API Key saved successfully!');
        apiKeyInput.value = '';
    } else {
        alert('Please enter a valid API key.');
    }
}

function loadAPIKey() {
    apiKey = localStorage.getItem('openaiAPIKey') || '';
}

window.onclick = (event) => {
    const modal = document.getElementById('apiModal');
    if (event.target === modal) {
        closeAPIModal();
    }
};

// ========== CHAT FUNCTIONS ==========
function scrollToChat() {
    document.getElementById('chatSection').scrollIntoView({ behavior: 'smooth' });
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();

    if (!message) return;

    addUserMessage(message);
    userInput.value = '';
    showLoadingIndicator();

    setTimeout(() => {
        processMessage(message);
    }, 500);
}

function sendQuickMessage(type) {
    const quickMessages = {
        bill: currentLanguage === 'gujarati' 
            ? 'ркорк╛рк░рлЛ ркмрк┐рк▓ ркХрлНркпрк╛ркВ ркЬрлЛркИ рк╢ркХрлБркВ?' 
            : 'Where can I check my bill?',
        powercut: currentLanguage === 'gujarati'
            ? 'рккрк╛рк╡рк░ ркХркЯ рк╢рлБркВ ркЫрлЗ?'
            : 'What is a power cut?',
        connection: currentLanguage === 'gujarati'
            ? 'ркирк╡рлЛ ркХркирлЗркХрлНрк╢рки ркХрлЗрк╡рлА рк░рлАркдрлЗ рк▓рлЗрк╡рлБркВ?'
            : 'How to get a new connection?',
        complaint: currentLanguage === 'gujarati'
            ? 'ркорлЗ рклрк░рк┐ркпрк╛ркж ркХрлЗрк╡рлА рк░рлАркдрлЗ ркжрк░рлНркЬ ркХрк░рк╡рлА?'
            : 'How to register a complaint?'
    };

    const message = quickMessages[type];
    addUserMessage(message);
    showLoadingIndicator();

    setTimeout(() => {
        processMessage(message, type);
    }, 500);
}

function addUserMessage(message) {
    const chatHistory = document.getElementById('chatHistory');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `<p>${escapeHtml(message)}</p>`;
    chatHistory.appendChild(messageDiv);
    scrollChatToBottom();
}

function addBotMessage(message) {
    const chatHistory = document.getElementById('chatHistory');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message';
    messageDiv.innerHTML = `<p>${escapeHtml(message)}</p>`;
    chatHistory.appendChild(messageDiv);
    scrollChatToBottom();
}

function scrollChatToBottom() {
    const chatHistory = document.getElementById('chatHistory');
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function showLoadingIndicator() {
    document.getElementById('loadingIndicator').style.display = 'block';
    scrollChatToBottom();
}

function hideLoadingIndicator() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

// ========== MESSAGE PROCESSING ==========
async function processMessage(message, quickType = null) {
    let response;

    if (quickType) {
        response = getQuickResponse(quickType);
        hideLoadingIndicator();
        addBotMessage(response);
    } else if (apiKey && apiKey.startsWith('sk-')) {
        try {
            response = await getOpenAIResponse(message);
            hideLoadingIndicator();
            addBotMessage(response);
        } catch (error) {
            hideLoadingIndicator();
            const errorMsg = currentLanguage === 'gujarati'
                ? 'ркорк╛ркл ркХрк░ркЬрлЛ, ркХркВркИркХ ркнрлВрк▓ ркЖрк╡рлА. рккрк░ркд рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ ркЕркерк╡рк╛ GEB 1912 рккрк░ ркХрлЙрк▓ ркХрк░рлЛ.'
                : 'Sorry, something went wrong. Please try again or call GEB at 1912.';
            addBotMessage(errorMsg);
        }
    } else {
        response = getLocalResponse(message);
        hideLoadingIndicator();
        addBotMessage(response);
    }
}

function getQuickResponse(type) {
    const t = translations[currentLanguage];
    const responses = {
        bill: t.billResponse,
        powercut: t.powerCutResponse,
        connection: t.connectionResponse,
        complaint: t.complaintResponse
    };
    return responses[type] || t.greeting;
}

function getLocalResponse(message) {
    const msg = message.toLowerCase();
    const t = translations[currentLanguage];

    // Gujarati keywords
    if (currentLanguage === 'gujarati') {
        if (msg.includes('ркмрк┐рк▓') || msg.includes('рккрлЗркорлЗркирлНркЯ')) return t.billResponse;
        if (msg.includes('рккрк╛рк╡рк░') || msg.includes('ркмрк┐ркЬрк▓рлА') || msg.includes('ркХркЯ')) return t.powerCutResponse;
        if (msg.includes('ркХркирлЗркХрлНрк╢рки') || msg.includes('ркирк╡рлЛ')) return t.connectionResponse;
        if (msg.includes('рклрк░рк┐ркпрк╛ркж') || msg.includes('рк╢рк┐ркХрк╛ркпркд')) return t.complaintResponse;
    }

    // English keywords
    if (msg.includes('bill') || msg.includes('payment')) return t.billResponse;
    if (msg.includes('power') || msg.includes('cut') || msg.includes('electricity')) return t.powerCutResponse;
    if (msg.includes('connection') || msg.includes('new')) return t.connectionResponse;
    if (msg.includes('complaint') || msg.includes('issue')) return t.complaintResponse;

    // Default response
    const defaultMsg = currentLanguage === 'gujarati'
        ? 'ркЖ рккрлНрк░рк╢рлНркиркирлЛ рк╕рлАркзрлЛ ркЬрк╡рк╛ркм ркЖрккрк╡рк╛ ркорк╛ркЯрлЗ ркорк╛рк░рлА рккрк╛рк╕рлЗ ркорк╛рк╣рк┐ркдрлА ркиркерлА. ркХрлГрккркпрк╛ GEB ркХрк╕рлНркЯркорк░ ркХрлЗрк░ 1912 рккрк░ рк╕ркВрккрк░рлНркХ ркХрк░рлЛ ркЕркерк╡рк╛ ркЙрккрк░ркирлЛ ркХрлНрк╡рк┐ркХ ркмркЯрки ркдрккрк╛рк╕рлЛ.'
        : 'I don\'t have direct information about this question. Please contact GEB Customer Care at 1912 or check the quick buttons above.';
    return defaultMsg;
}

async function getOpenAIResponse(message) {
    const systemPrompt = currentLanguage === 'gujarati'
        ? 'ркдркорлЗ Anand Dhokai ркирк╛ркоркирлЛ ркПркХ ркорк┐ркдрлНрк░рк╡ркдрлН рк╕рк╣рк╛ркпркХ рк╣рлЛ ркЬрлЗ ркЧрлБркЬрк░рк╛ркд ркЗрк▓рлЗркХрлНркЯрлНрк░рк┐ркХ ркмрлЛрк░рлНркб (GEB) рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ркУркирлЗ ркмрк┐ркЬрк▓рлА рк╕ркВркмркВркзрк┐ркд рккрлНрк░рк╢рлНркирлЛркорк╛ркВ ркоркжркж ркХрк░рлЗ ркЫрлЛ. ркдркорлЗ рк╕рк░рк│ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рк╣рк▓рлАркорлБрк▓рлАркд ркЬрк╡рк╛ркм ркЖрккрлЛ, ркдркХркирлАркХрлА рк╢ркмрлНркжрлЛ ркЯрк╛рк│рлЛ, ркЕркирлЗ ркЬрлЛ ркдркоркирлЗ ркЦрк╛ркдрк░рлА рки рк╣рлЛркп ркдрлЛ GEB ркХрк╕рлНркЯркорк░ ркХрлЗрк░ 1912 рккрк░ рк╕ркВрккрк░рлНркХ ркХрк░рк╡рк╛ркирлА рк╕рк▓рк╛рк╣ ркЖрккрлЛ.'
        : 'You are a friendly assistant named Anand Dhokai helping Gujarat Electric Board (GEB) users with electricity-related queries. Provide helpful answers in simple English, avoid technical jargon, and suggest contacting GEB Customer Care at 1912 if you\'re unsure.';

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: message }
            ],
            max_tokens: 300,
            temperature: 0.7
        })
    });

    if (!response.ok) {
        throw new Error(`API Error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices[0].message.content;
}

// ========== CHAT HISTORY MANAGEMENT ==========
function clearChat() {
    if (confirm(currentLanguage === 'gujarati'
        ? 'рк╢рлБркВ ркдркорлЗ ркЪрлЗркЯ ркЗркдрк┐рк╣рк╛рк╕ рк╕рк╛ркл ркХрк░рк╡рк╛ ркЫрлЛ?'
        : 'Are you sure you want to clear chat history?')) {
        const chatHistoryDiv = document.getElementById('chatHistory');
        chatHistoryDiv.innerHTML = `
            <div class="message bot-message">
                <p>${translations[currentLanguage].greeting}</p>
            </div>
        `;
    }
}

// ========== SEO & METADATA ==========
// Already included in HTML meta tags

// ========== ACCESSIBILITY ENHANCEMENTS ==========
// Font size boost for senior citizens
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === '+') {
        document.body.style.fontSize = 'larger';
    }
    if (e.ctrlKey && e.key === '-') {
        document.body.style.fontSize = 'smaller';
    }
});

// Skip to main content for keyboard users
const skipLink = document.createElement('a');
skipLink.href = '#chatSection';
skipLink.textContent = 'Skip to chat';
skipLink.className = 'skip-link';
skipLink.style.cssText = `
    position: absolute;
    top: -40px;
    left: 0;
    background: #1976D2;
    color: white;
    padding: 8px;
    text-decoration: none;
    z-index: 100;
`;
skipLink.addEventListener('focus', () => {
    skipLink.style.top = '0';
});
skipLink.addEventListener('blur', () => {
    skipLink.style.top = '-40px';
});
document.body.insertBefore(skipLink, document.body.firstChild);
